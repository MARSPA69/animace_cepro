// DEBUG REPORTING SYSTEM
// Sbƒõr debug log≈Ø a generov√°n√≠ PDF report≈Ø

(function() {
  'use strict';

  // Glob√°ln√≠ objekt pro debug reporting
  window.DebugReporting = {
    logs: [],
    sessionStartTime: null,
    sessionEndTime: null,
    isActive: false,
    originalConsoleLog: null,
    originalConsoleError: null,
    originalConsoleWarn: null,
    
    // Kategorizace log≈Ø podle emoji a prefix≈Ø
    LOG_CATEGORIES: {
      'üî¥': 'CRITICAL',
      'üîç': 'ANCHOR_DEBUG', 
      '‚è∞': 'TIMING_DEBUG',
      '‚úÖ': 'DECISION_DEBUG',
      'üö®': 'FALLBACK_DEBUG',
      '‚öôÔ∏è': 'CONFIG_DEBUG',
      'üö∂': 'WALKER_DEBUG',
      'üí•': 'ERROR_DEBUG',
      'üìä': 'SUMMARY_DEBUG',
      'üü¢': 'STATUS_DEBUG',
      '‚ö†Ô∏è': 'WARNING_DEBUG',
      'üîÆ': 'PREDICTION_DEBUG',
      'üöÄ': 'BUILD_START',
      'üîÑ': 'LOOP',
      'üéØ': 'TARGET',
      'üö™': 'EXIT',
      'üö¶': 'CROSS_MODE'
    },

    // Inicializace debug reporting syst√©mu
    init() {
      console.log('üîß [DEBUG-REPORTING] Initializing debug reporting system...');
      this.setupEventListeners();
      this.createReportingDirectory();
    },

    // Nastaven√≠ event listener≈Ø pro buttony
    setupEventListeners() {
      const debugReportBtn = document.getElementById('debug-report-btn');
      const chartsTablesBtn = document.getElementById('charts-tables-btn');

      if (debugReportBtn) {
        debugReportBtn.addEventListener('click', (e) => {
          e.preventDefault();
          this.generateDebugReport();
        });
      }

      if (chartsTablesBtn) {
        chartsTablesBtn.addEventListener('click', (e) => {
          e.preventDefault();
          this.showChartsAndTables();
        });
      }
    },

    // Spu≈°tƒõn√≠ sbƒõru debug log≈Ø
    startLogging() {
      if (this.isActive) {
        console.warn('‚ö†Ô∏è [DEBUG-REPORTING] Logging already active');
        return;
      }

      this.sessionStartTime = new Date();
      this.isActive = true;
      this.logs = [];

      // Ulo≈æen√≠ origin√°ln√≠ch console funkc√≠
      this.originalConsoleLog = console.log;
      this.originalConsoleError = console.error;
      this.originalConsoleWarn = console.warn;

      // P≈ôeps√°n√≠ console funkc√≠ pro zachycen√≠ log≈Ø
      console.log = (...args) => {
        this.captureLog('LOG', args);
        this.originalConsoleLog.apply(console, args);
      };

      console.error = (...args) => {
        this.captureLog('ERROR', args);
        this.originalConsoleError.apply(console, args);
      };

      console.warn = (...args) => {
        this.captureLog('WARN', args);
        this.originalConsoleWarn.apply(console, args);
      };

      console.log('üöÄ [DEBUG-REPORTING] Debug logging started at', this.sessionStartTime.toLocaleString());
    },

    // Zastaven√≠ sbƒõru debug log≈Ø
    stopLogging() {
      if (!this.isActive) {
        console.warn('‚ö†Ô∏è [DEBUG-REPORTING] Logging not active');
        return;
      }

      this.sessionEndTime = new Date();
      this.isActive = false;

      // Obnoven√≠ origin√°ln√≠ch console funkc√≠
      console.log = this.originalConsoleLog;
      console.error = this.originalConsoleError;
      console.warn = this.originalConsoleWarn;

      console.log('‚èπÔ∏è [DEBUG-REPORTING] Debug logging stopped at', this.sessionEndTime.toLocaleString());
      console.log('üìä [DEBUG-REPORTING] Total logs captured:', this.logs.length);
    },

    // Zachycen√≠ log zpr√°vy
    captureLog(level, args) {
      const message = args.join(' ');
      const timestamp = new Date();
      
      const logEntry = {
        timestamp: timestamp,
        level: level,
        category: this.extractCategory(message),
        message: message,
        data: this.extractData(message),
        sessionTime: this.sessionStartTime ? (timestamp - this.sessionStartTime) / 1000 : 0
      };

      this.logs.push(logEntry);
    },

    // Extrakce kategorie z log zpr√°vy
    extractCategory(message) {
      // Hled√°n√≠ emoji v zpr√°vƒõ
      for (const [emoji, category] of Object.entries(this.LOG_CATEGORIES)) {
        if (message.includes(emoji)) {
          return category;
        }
      }

      // Hled√°n√≠ prefix≈Ø v hranat√Ωch z√°vork√°ch
      const bracketMatch = message.match(/\[([^\]]+)\]/);
      if (bracketMatch) {
        return bracketMatch[1].toUpperCase();
      }

      return 'GENERAL';
    },

    // Extrakce dat z log zpr√°vy
    extractData(message) {
      const data = {};
      
      // Extrakce ƒçasu
      const timeMatch = message.match(/(\d{2}:\d{2}:\d{2})/);
      if (timeMatch) {
        data.time = timeMatch[1];
      }

      // Extrakce sou≈ôadnic
      const coordMatch = message.match(/(\d+\.\d+),(\d+\.\d+)/);
      if (coordMatch) {
        data.lat = parseFloat(coordMatch[1]);
        data.lng = parseFloat(coordMatch[2]);
      }

      // Extrakce anchor IDs
      const anchorMatch = message.match(/\[([0-9,\s]+)\]/);
      if (anchorMatch) {
        data.anchors = anchorMatch[1].split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
      }

      // Extrakce mesh ID
      const meshMatch = message.match(/MESH=(\d+)/);
      if (meshMatch) {
        data.meshId = parseInt(meshMatch[1]);
      }

      return data;
    },

    // Vytvo≈ôen√≠ reporting adres√°≈ôe (webov√° verze)
    createReportingDirectory() {
      // V webov√©m prost≈ôed√≠ nem≈Ø≈æeme vytv√°≈ôet adres√°≈ôe
      // PDF se st√°hne do defaultn√≠ho download adres√°≈ôe u≈æivatele
      console.log('üìÅ [DEBUG-REPORTING] PDF reports will be downloaded to user\'s default download directory');
    },

    // Generov√°n√≠ debug reportu
    async generateDebugReport() {
      try {
        console.log('üìä [DEBUG-REPORTING] Generating debug report...');
        
        // Zastaven√≠ logov√°n√≠ pokud je aktivn√≠
        if (this.isActive) {
          this.stopLogging();
        }

        // Generov√°n√≠ PDF
        const pdfBlob = await this.generatePDF();
        
        // Ulo≈æen√≠ PDF
        const fileName = this.generateFileName();
        await this.savePDF(pdfBlob, fileName);
        
        // Zobrazen√≠ √∫spƒõ≈°n√© zpr√°vy
        this.showSuccessMessage(fileName);
        
      } catch (error) {
        console.error('üí• [DEBUG-REPORTING] Failed to generate report:', error);
        this.showErrorMessage(error);
      }
    },

    // Generov√°n√≠ PDF reportu
    async generatePDF() {
      // jsPDF je dostupn√Ω glob√°lnƒõ
      const doc = new window.jspdf.jsPDF();
      
      // Header
      doc.setFontSize(20);
      doc.text('DEBUG LOG REPORT', 20, 20);
      
      // Metadata
      doc.setFontSize(12);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 35);
      doc.text(`Session: ${this.sessionStartTime ? this.sessionStartTime.toLocaleString() : 'N/A'} - ${this.sessionEndTime ? this.sessionEndTime.toLocaleString() : 'N/A'}`, 20, 45);
      doc.text(`Total Logs: ${this.logs.length}`, 20, 55);
      
      // Statistiky
      const stats = this.generateStatistics();
      doc.text(`Errors: ${stats.errors}`, 20, 65);
      doc.text(`Warnings: ${stats.warnings}`, 20, 75);
      doc.text(`Critical: ${stats.critical}`, 20, 85);
      
      // Kategorie log≈Ø
      const categories = this.groupLogsByCategory();
      let yPosition = 100;
      
      Object.keys(categories).forEach(category => {
        if (yPosition > 280) {
          doc.addPage();
          yPosition = 20;
        }
        
        doc.setFontSize(14);
        doc.text(`${category} (${categories[category].length} logs)`, 20, yPosition);
        yPosition += 10;
        
        categories[category].slice(0, 20).forEach(log => { // Limit 20 log≈Ø na kategorii
          if (yPosition > 280) {
            doc.addPage();
            yPosition = 20;
          }
          
          doc.setFontSize(9);
          const logText = `${log.timestamp.toLocaleTimeString()}: ${log.message.substring(0, 80)}${log.message.length > 80 ? '...' : ''}`;
          doc.text(logText, 25, yPosition);
          yPosition += 5;
        });
        yPosition += 10;
      });
      
      return doc.output('blob');
    },

    // Seskupen√≠ log≈Ø podle kategorie
    groupLogsByCategory() {
      const categories = {};
      
      this.logs.forEach(log => {
        if (!categories[log.category]) {
          categories[log.category] = [];
        }
        categories[log.category].push(log);
      });
      
      // Se≈ôazen√≠ podle poƒçtu log≈Ø
      return Object.keys(categories)
        .sort((a, b) => categories[b].length - categories[a].length)
        .reduce((result, key) => {
          result[key] = categories[key];
          return result;
        }, {});
    },

    // Generov√°n√≠ statistik
    generateStatistics() {
      const stats = {
        errors: 0,
        warnings: 0,
        critical: 0,
        total: this.logs.length
      };
      
      this.logs.forEach(log => {
        if (log.level === 'ERROR') stats.errors++;
        if (log.level === 'WARN') stats.warnings++;
        if (log.category === 'CRITICAL') stats.critical++;
      });
      
      return stats;
    },

    // Generov√°n√≠ n√°zvu souboru
    generateFileName() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      
      return `Log report_${year}_${day}_${month}.pdf`;
    },

    // Ulo≈æen√≠ PDF souboru
    async savePDF(pdfBlob, fileName) {
      try {
        // Pro webov√© prost≈ôed√≠ - sta≈æen√≠ souboru do defaultn√≠ho download adres√°≈ôe
        const url = URL.createObjectURL(pdfBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        console.log('üíæ [DEBUG-REPORTING] PDF downloaded as:', fileName);
        console.log('üìÅ [DEBUG-REPORTING] File saved to user\'s default download directory');
      } catch (error) {
        console.error('üí• [DEBUG-REPORTING] Failed to save PDF:', error);
        throw error;
      }
    },

    // Zobrazen√≠ √∫spƒõ≈°n√© zpr√°vy
    showSuccessMessage(fileName) {
      // Pou≈æit√≠ AdminLTE toast notifikace
      if (window.toastr) {
        window.toastr.success(`Debug report generated successfully: ${fileName}`, 'Success');
      } else {
        alert(`Debug report generated successfully: ${fileName}`);
      }
    },

    // Zobrazen√≠ chybov√© zpr√°vy
    showErrorMessage(error) {
      if (window.toastr) {
        window.toastr.error(`Failed to generate report: ${error.message}`, 'Error');
      } else {
        alert(`Failed to generate report: ${error.message}`);
      }
    },

    // Zobrazen√≠ Charts & Tables (placeholder)
    showChartsAndTables() {
      console.log('üìä [DEBUG-REPORTING] Charts & Tables feature coming soon...');
      if (window.toastr) {
        window.toastr.info('Charts & Tables feature coming soon...', 'Info');
      } else {
        alert('Charts & Tables feature coming soon...');
      }
    }
  };

  // Automatick√© spu≈°tƒõn√≠ p≈ôi naƒçten√≠ str√°nky
  document.addEventListener('DOMContentLoaded', () => {
    window.DebugReporting.init();
    
    // Automatick√© spu≈°tƒõn√≠ logov√°n√≠
    window.DebugReporting.startLogging();
    
    console.log('üîß [DEBUG-REPORTING] System initialized and logging started');
  });

})();
